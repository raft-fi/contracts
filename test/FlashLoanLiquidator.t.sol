// SPDX-License-Identifier: MIT
pragma solidity 0.8.19;

import { Test } from "forge-std/Test.sol";
import { IPositionManager } from "../contracts/Interfaces/IPositionManager.sol";
import { IAMM } from "../contracts/Interfaces/IAMM.sol";
import { IPriceFeed } from "../contracts/Interfaces/IPriceFeed.sol";
import { FlashLoanLiquidator } from "../contracts/FlashLoanLiquidator.sol";
import { IERC20 } from "@openzeppelin/contracts/token/ERC20/IERC20.sol";

// solhint-disable max-line-length
contract FlashLoanLiquidatorTest is Test {
    IERC20 public constant collateralToken = IERC20(0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0); // WSTETH
    address public constant AGGREGATION_ROUTER_V5 = 0x1111111254EEB25477B68fb85Ed929f73A960582;
    IPositionManager public constant positionManager = IPositionManager(0x5F59b322eB3e16A0C78846195af1F588b77403FC);
    address public constant AMM = 0x10fbb5A361aA1a35bf2d0a262E24125Fd39D33d8; // one inch amm

    FlashLoanLiquidator public liquidator;

    function setUp() public {
        vm.createSelectFork("mainnet", 17_465_519);

        liquidator = new FlashLoanLiquidator(positionManager, IAMM(AMM), collateralToken);
    }

    // Closes a position that has 100% < ICR < 110% (MCR)
    function testFlashLoanLiquidatorLiquidate() public {
        address whale = 0xccFa0530B9d52f970d1A2dAEa670ce58E4176389;

        uint256 fromAmountOffset = 164;
        bytes memory swapCalldata =
            hex"12aa3caf00000000000000000000000092f3f71cef740ed5784874b8c70ff87ecdf335880000000000000000000000007f39c581f595b53c5cb19bd0b3f8da6c935e2ca0000000000000000000000000183015a9ba6ff60230fdeadc3f43b3d788b13e2100000000000000000000000092f3f71cef740ed5784874b8c70ff87ecdf3358800000000000000000000000010fbb5a361aa1a35bf2d0a262e24125fd39d33d8000000000000000000000000000000000000000000000140d4a83d1b03ebca080000000000000000000000000000000000000000000490dd9eec3069df1eec89000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000015f10000000000000000000000000000000000000000000000000000000015d300a007e5c0d20000000000000000000000000000000015af00154c0001d00001ca00003c41207f39c581f595b53c5cb19bd0b3f8da6c935e2ca00004de0e9a3e000000000000000000000000000000000000000000000000000000000000000000a0c9e75c48000000000000000022100000000000000000000000000000000000000000000000000001600000b0510021e27a5e5513d6e65c4f830167390997aa84843aae7ab96520de3a18e5e111b5eaab095312d7fe8400443df02124000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000039d7125aea28ea37ed5120dc24316b9ae028f1497c275eb9192a3ea0f67022ae7ab96520de3a18e5e111b5eaab095312d7fe8400443df0212400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007ae76c02afea31f48100206b4be0b900a0c9e75c480806050402020101001500134e000ebe000e6f000e20000a900007000003700002f500027a00026000a007e5c0d200000000000000000000000000000000023c0002220001720000b600009c4160c5424b857f758e906013f3555dad202e4bdb456700443df0212400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010020d6bdbf785e74c9036fb86bd7ecdcb084a0673efc32ea31cb4120c011a73ee8576fb46f5e1c5751ca3b9fe0af2a6f002444b3e92373455448000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000735553440000000000000000000000000000000000000000000000000000000031494e434800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005120a5407eae9ba41422680e2e00537571bcc53efbfd57ab1ec28d129707052df4df418d58a2d46d5f5100443df0212400000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010020d6bdbf786b175474e89094c44da98b954eedeac495271d0f4041c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2d0e30db00c20c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2c3d03e4f041fd4cd388c549ee2a29a9e5075882f6ae4071118002dc6c0c3d03e4f041fd4cd388c549ee2a29a9e5075882f0000000000000000000000000000000000000000000016fbc23966f3dcb67cecc02aaa39b223fe8d0a0e5c4f27ead9083c756cc20c20c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2a478c2975ab1ea89e8196811f51a7b7ade33eb116ae4071118002dc6c0a478c2975ab1ea89e8196811f51a7b7ade33eb110000000000000000000000000000000000000000000017a701d2ca3481b9c0e8c02aaa39b223fe8d0a0e5c4f27ead9083c756cc251001111111254eeb25477b68fb85ed929f73a960582c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2008462e238bb00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002e0000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000002f4ddb127f52fec6978c00000000000000000000000000000000000000000000000000000072ad27ec210000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000005ef001e2c572b8e5eeb34ff8f0c79f0dfc2c7df2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000069e10de76676d08000000000000000000000000000000000000000000000000000102e9f8bc0cc027500000000a4000000a4000000a4000000a400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000a4bf15fcd8000000000000000000000000303389f541ff2d620e42832f180a08e767b28e10000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000242cc2878d0064d59ef5000000000400005ef001e2c572b8e5eeb34ff8f0c79f0dfc2c7df20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004066093804e60d17cbb56a64aee523425626bccd976f861423ed9c78eee4974fba705852b5a52eb95a746424ed008dfca81027f478a008c2e556627c74ffd74dd5000000000000000000000000000000000000000000000000000000000000000051001111111254eeb25477b68fb85ed929f73a960582c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2008462e238bb00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002e0000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000002eefde6a63219b6be709000000000000000000000000000000000000000000000000000000cc611b9e790000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000005ef001e2c572b8e5eeb34ff8f0c79f0dfc2c7df2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000069e10de76676d08000000000000000000000000000000000000000000000000000104f06c338238d1470000000a4000000a4000000a4000000a400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000a4bf15fcd8000000000000000000000000303389f541ff2d620e42832f180a08e767b28e10000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000242cc2878d0064e56416000000000400005ef001e2c572b8e5eeb34ff8f0c79f0dfc2c7df200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040f565b36d4b9bdcc5a82520fd15f125c3e0fb2ed8103ebceec76003b28362a978230fe1cf48fbff7b002bcd734ad24bbeaa350b369535234d9797b2b6d94bbe48000000000000000000000000000000000000000000000000000000000000000051001111111254eeb25477b68fb85ed929f73a960582c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2008462e238bb00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002e0000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000005bc8bc2b883db3a93724000000000000000000000000000000000000000000000000000000716ae53b1c0000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000005ef001e2c572b8e5eeb34ff8f0c79f0dfc2c7df20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d3c21bcecceda10000000000000000000000000000000000000000000000000000215c2d573eb062b240000000a4000000a4000000a4000000a400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000a4bf15fcd8000000000000000000000000303389f541ff2d620e42832f180a08e767b28e10000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000242cc2878d0064dd5c86000000000400005ef001e2c572b8e5eeb34ff8f0c79f0dfc2c7df2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000406c054a5aeb29ff26952cc545893eaf8d926e4addf9e4cbc277d5888ea4536ac93711ae79e3db96673319c06d43851c406c2909e6cd95e6c35603a2788780b396000000000000000000000000000000000000000000000000000000000000000002a00000000000000000000000000000000000000000000075d5977f163a5ba371b8ee63c1e50060594a405d53811d3bc4766596efd80fd545a270c02aaa39b223fe8d0a0e5c4f27ead9083c756cc202a0000000000000000000000000000000000000000000008d831404e340faf89b43ee63c1e500c2e9f25be6257c210d7adf0d4cd6e3e881ba25f8c02aaa39b223fe8d0a0e5c4f27ead9083c756cc251001111111254eeb25477b68fb85ed929f73a960582c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2008462e238bb00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000003e000000000000000000000000000000000000000000000000000000000000004400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000bbbf79a98c867272e7c3000000000000000000000000000000000000000000000000000000fb4c3bc83a0000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000a7277c7b0ef6fe2e1c4f69df847fd79dcf6ca3c80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001793a9c257ba5df9be6a600000000000000000000000000000000000000000000003a1ae5389a97d814a0000001b8000001b8000001b8000000a400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001b8bf15fcd8000000000000000000000000303389f541ff2d620e42832f180a08e767b28e10000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000242cc2878d0064e5604c00000000000000a7277c7b0ef6fe2e1c4f69df847fd79dcf6ca3c8000000000000000000000000000000000000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000a7277c7b0ef6fe2e1c4f69df847fd79dcf6ca3c80000000000000000000000001111111254eeb25477b68fb85ed929f73a96058200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000064e560430000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000001c7f0025babc586209f0ae585c39b2cc328af7061a668dc490a542e329f0757d023f1c5bc58e2b33c29e46a382cd60cc908dffe9393b2eff84affd2242dd85847400000000000000000000000000000000000000000000000000000000000000000000000000000040bbc8562618bff4dd6388625dd03a5fae617ea954ba9d178313c57fbe171ceb0cc2e074fa7de29e066ef5ddaeeca08a0edf42c58245cfa0d5ab331b6513eb3e43000000000000000000000000000000000000000000000000000000000000000000a0fbb7cd068020a61b948e33879ce7f23e535cc7baa3bc66c5a90000000000000000000005556b175474e89094c44da98b954eedeac495271d0f183015a9ba6ff60230fdeadc3f43b3d788b13e211111111254eeb25477b68fb85ed929f73a9605820000000000000000000000000000008c4b600c";
        bytes memory ammData = abi.encode(fromAmountOffset, swapCalldata);

        (,, IPriceFeed priceFeed,,,,,,,) = IPositionManager(positionManager).collateralInfo(collateralToken);

        vm.mockCall(address(priceFeed), abi.encodeWithSelector(IPriceFeed.fetchPrice.selector), abi.encode(1720e18, 0));

        liquidator.liquidate(whale, ammData);
        assertEq(positionManager.raftDebtToken(collateralToken).balanceOf(whale), 0);
    }
}

// SPDX-License-Identifier: MIT
pragma solidity 0.8.19;

import { Test } from "forge-std/Test.sol";
import { IVault } from "@balancer-labs/v2-interfaces/contracts/vault/IVault.sol";
import { IERC20 } from "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import { IPositionManager } from "../contracts/Interfaces/IPositionManager.sol";
import { IAMM } from "../contracts/Interfaces/IAMM.sol";
import { OneInchV5BalancerAMM } from "../contracts/AMMs/OneInchV5BalancerAMM.sol";
import { IPriceFeed } from "../contracts/Interfaces/IPriceFeed.sol";
import { FlashLoanLiquidator } from "../contracts/FlashLoanLiquidator.sol";

// solhint-disable max-line-length
contract FlashLoanLiquidatorTest is Test {
    IERC20 public constant collateralToken = IERC20(0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0); // WSTETH
    address public constant AGGREGATION_ROUTER_V5 = 0x1111111254EEB25477B68fb85Ed929f73A960582;
    address public constant BALANCER_VAULT = 0xBA12222222228d8Ba445958a75a0704d566BF2C8;
    IPositionManager public constant positionManager = IPositionManager(0x5F59b322eB3e16A0C78846195af1F588b77403FC);
    OneInchV5BalancerAMM public amm;

    FlashLoanLiquidator public liquidator;

    function setUp() public {
        vm.createSelectFork("mainnet", 17_470_095);

        amm = new OneInchV5BalancerAMM(AGGREGATION_ROUTER_V5, IVault(BALANCER_VAULT));
        liquidator = new FlashLoanLiquidator(positionManager, amm, collateralToken);
    }

    // Closes a position that has 100% < ICR < 110% (MCR)
    function testFlashLoanLiquidatorLiquidateWrappedCollateral() public {
        address whale = 0xccFa0530B9d52f970d1A2dAEa670ce58E4176389;

        uint256 fromAmountOffset = 164;
        /// WstETH --> DAI
        bytes memory swapCalldata =
            hex"12aa3caf00000000000000000000000092f3f71cef740ed5784874b8c70ff87ecdf335880000000000000000000000007f39c581f595b53c5cb19bd0b3f8da6c935e2ca00000000000000000000000006b175474e89094c44da98b954eedeac495271d0f00000000000000000000000092f3f71cef740ed5784874b8c70ff87ecdf335880000000000000000000000005615deb798bb3e4dfa0139dfa1b3d433cc23b72f00000000000000000000000000000000000000000000017cf5b5e3c4e2b8e63d00000000000000000000000000000000000000000005b3c532b35c2a5203c89c00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002ce0000000000000000000000000002cc2002c56002b120029ce0029a000295600a0c9e75c48000000000000000009010000000000000000000000000000000000000000000000000029280023e800a007e5c0d20000000000000000000000000023c40023aa0022fa0022e000207a00003c41207f39c581f595b53c5cb19bd0b3f8da6c935e2ca00004de0e9a3e000000000000000000000000000000000000000000000000000000000000000000a0c9e75c4800060606060606060602000000002010001c800018f00015600011d0000e40000ab000072000039051001111111254eeb25477b68fb85ed929f73a960582ae7ab96520de3a18e5e111b5eaab095312d7fe84008462e238bb00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002e0000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000daba1e4cdf7be483000000000000000000000000000000000000000000000000000000308e593377000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000ae7ab96520de3a18e5e111b5eaab095312d7fe84000000000000000000000000741aa7cfb2c7bf2a1e7d4da2e3df6a56ca4131f30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003635c9adc5dea00000000000000000000000000000000000000000000000000036898b08ec3b09d5a0000000a4000000a4000000a4000000a400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000a4bf15fcd8000000000000000000000000303389f541ff2d620e42832f180a08e767b28e10000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000242cc2878d0064abb55600000000000000741aa7cfb2c7bf2a1e7d4da2e3df6a56ca4131f300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040592b9120e0a9d0244f2f7eeb5dd56ae2c4f5226998f5f3deb9765a871f6b758f1b39f1f765c283c586afc7aad6ea33d6844acb732ec19d97a6c37b45e23d211a000000000000000000000000000000000000000000000000000000000000000051001111111254eeb25477b68fb85ed929f73a960582ae7ab96520de3a18e5e111b5eaab095312d7fe84008462e238bb00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002e0000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000002927dd77684919466000000000000000000000000000000000000000000000000000000557d19c22b000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000ae7ab96520de3a18e5e111b5eaab095312d7fe84000000000000000000000000741aa7cfb2c7bf2a1e7d4da2e3df6a56ca4131f30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003635c9adc5dea00000000000000000000000000000000000000000000000000036588e270eae65eea0000000a4000000a4000000a4000000a400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000a4bf15fcd8000000000000000000000000303389f541ff2d620e42832f180a08e767b28e10000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000242cc2878d0064abaf2400000000000000741aa7cfb2c7bf2a1e7d4da2e3df6a56ca4131f3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000408c5ed8fc7aab174bf3806865c0c900d1b5c0285702d987750e847856ce4b30dfbd78a44f09dfb35c9499d04777217c3fe1dd90e60e4ade2e69ac0abf4d68e720000000000000000000000000000000000000000000000000000000000000000051001111111254eeb25477b68fb85ed929f73a960582ae7ab96520de3a18e5e111b5eaab095312d7fe84008462e238bb00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002e0000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000002918058efb43b9f500000000000000000000000000000000000000000000000000000008b16f0da78000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000ae7ab96520de3a18e5e111b5eaab095312d7fe84000000000000000000000000741aa7cfb2c7bf2a1e7d4da2e3df6a56ca4131f30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003635c9adc5dea000000000000000000000000000000000000000000000000000366d82061f7ff60520000000a4000000a4000000a4000000a400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000a4bf15fcd8000000000000000000000000303389f541ff2d620e42832f180a08e767b28e10000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000242cc2878d0064abb4a100000000000000741aa7cfb2c7bf2a1e7d4da2e3df6a56ca4131f30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004054db706e64cb8a3dcbcbc7d04a8fa2f7a0073dc187bcd6709f6cdca210e50a8c9faf500afcf723c419feffe332cf0022011a09ee784736dd9142158ec94efd5a000000000000000000000000000000000000000000000000000000000000000051001111111254eeb25477b68fb85ed929f73a960582ae7ab96520de3a18e5e111b5eaab095312d7fe84008462e238bb00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002e0000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000002922957f43f1f99ce000000000000000000000000000000000000000000000000000000b43c1e58e0000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000ae7ab96520de3a18e5e111b5eaab095312d7fe84000000000000000000000000741aa7cfb2c7bf2a1e7d4da2e3df6a56ca4131f30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003635c9adc5dea000000000000000000000000000000000000000000000000000365f8850fc43671480000000a4000000a4000000a4000000a400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000a4bf15fcd8000000000000000000000000303389f541ff2d620e42832f180a08e767b28e10000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000242cc2878d0064abb47400000000000000741aa7cfb2c7bf2a1e7d4da2e3df6a56ca4131f30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004053c246fef53c07983c7358b300ff28037914e6fa5cd300f6f706f3b3b0ac48939b08043959fa77b4550b0e46a6db2fd3b53460095b17440fd057f20d289befb7000000000000000000000000000000000000000000000000000000000000000051001111111254eeb25477b68fb85ed929f73a960582ae7ab96520de3a18e5e111b5eaab095312d7fe84008462e238bb00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002e0000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000002922957f43f1f99ce000000000000000000000000000000000000000000000000000001089b1c2f78000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000ae7ab96520de3a18e5e111b5eaab095312d7fe84000000000000000000000000741aa7cfb2c7bf2a1e7d4da2e3df6a56ca4131f30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003635c9adc5dea000000000000000000000000000000000000000000000000000365f8850fc43671480000000a4000000a4000000a4000000a400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000a4bf15fcd8000000000000000000000000303389f541ff2d620e42832f180a08e767b28e10000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000242cc2878d0064abb34700000000000000741aa7cfb2c7bf2a1e7d4da2e3df6a56ca4131f30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004058d53271a9526b447313df4bb3dce16bc415217811a353b43ee45e836bdf7c4235ad384dbcccaf43cf866c5b5ae26776f49d9ee8fdb6b988fd12f75d122feb17000000000000000000000000000000000000000000000000000000000000000051001111111254eeb25477b68fb85ed929f73a960582ae7ab96520de3a18e5e111b5eaab095312d7fe84008462e238bb00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002e000000000000000000000000000000000000000000000000000000000000003400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000291d4d871f9ad86f800000000000000000000000000000000000000000000000000000000d6cdc309000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000ae7ab96520de3a18e5e111b5eaab095312d7fe84000000000000000000000000741aa7cfb2c7bf2a1e7d4da2e3df6a56ca4131f30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003635c9adc5dea00000000000000000000000000000000000000000000000000036668445c6e6302780000000a4000000a4000000a4000000a400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000a4bf15fcd8000000000000000000000000303389f541ff2d620e42832f180a08e767b28e10000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000242cc2878d0064abb48d00000000000000741aa7cfb2c7bf2a1e7d4da2e3df6a56ca4131f300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040c21e168cbbf047e644a3440814f16c46cb669b694d77c17ab74e58a4f83f8a668f2480976a9adc891ce9918a03e75c87b10538196c1d7652b270c19dfed08ca6000000000000000000000000000000000000000000000000000000000000000051001111111254eeb25477b68fb85ed929f73a960582ae7ab96520de3a18e5e111b5eaab095312d7fe84008462e238bb00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002e000000000000000000000000000000000000000000000000000000000000003400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000290d759eb29579a800000000000000000000000000000000000000000000000000000009ab111e0ff000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000ae7ab96520de3a18e5e111b5eaab095312d7fe84000000000000000000000000741aa7cfb2c7bf2a1e7d4da2e3df6a56ca4131f30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003635c9adc5dea000000000000000000000000000000000000000000000000000367b82ec40049bf360000000a4000000a4000000a4000000a400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000a4bf15fcd8000000000000000000000000303389f541ff2d620e42832f180a08e767b28e10000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000242cc2878d0064abb51600000000000000741aa7cfb2c7bf2a1e7d4da2e3df6a56ca4131f30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004060d76214de91e0e6fea4bc7da4f5ea5f6709f1a9e5a4d41d342f06a9e4280f50efcd3cbce10d58571c33ec392ecd9ab3f66b653aa622ecbd4ce9664242739b91000000000000000000000000000000000000000000000000000000000000000051001111111254eeb25477b68fb85ed929f73a960582ae7ab96520de3a18e5e111b5eaab095312d7fe84008462e238bb00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002e0000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000002912bd96d6ec996c1000000000000000000000000000000000000000000000000000001872526526b000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000ae7ab96520de3a18e5e111b5eaab095312d7fe84000000000000000000000000741aa7cfb2c7bf2a1e7d4da2e3df6a56ca4131f30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003635c9adc5dea00000000000000000000000000000000000000000000000000036748192b754f64a80000000a4000000a4000000a4000000a400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000a4bf15fcd8000000000000000000000000303389f541ff2d620e42832f180a08e767b28e10000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000242cc2878d0064abb4d900000000000000741aa7cfb2c7bf2a1e7d4da2e3df6a56ca4131f3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000406c45407b5150e57eae0c4518a91a0460d6ad85029f4599124927ae31cb9cf105916c520d71dcc7a335e7f22fbd88591629f5618771696068c01fbc5b83a9c6be000000000000000000000000000000000000000000000000000000000000000051201111111254eeb25477b68fb85ed929f73a960582ae7ab96520de3a18e5e111b5eaab095312d7fe84008462e238bb00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000002e00000000000000000000000000000000000000000000000000000000000000340000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000029082da68e3e5a14a000000000000000000000000000000000000000000000000000000a08d2a5848000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000ae7ab96520de3a18e5e111b5eaab095312d7fe84000000000000000000000000741aa7cfb2c7bf2a1e7d4da2e3df6a56ca4131f30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003635c9adc5dea000000000000000000000000000000000000000000000000000368286136b89c89820000000a4000000a4000000a4000000a400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000a4bf15fcd8000000000000000000000000303389f541ff2d620e42832f180a08e767b28e10000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000242cc2878d0064abb53100000000000000741aa7cfb2c7bf2a1e7d4da2e3df6a56ca4131f300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040b3c5f5ca446c7b3fc6ec8b8cc5fed0e0c3305cb029fd9f53cc355576df5907c0c8ab3f63a1d902b1117905c4ff193a0c9e7e5de55ed73fde56981af697a05096000000000000000000000000000000000000000000000000000000000000000000a0c9e75c480000000000160f0606010000000000000000000000000000000002380001e90001190000ca00007b0c20c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20d4a11d5eeaac28ec3f61d100daf4d40471f18526ae4071198002dc6c00d4a11d5eeaac28ec3f61d100daf4d40471f18520000000000000000000000000000000000000000000000000000000335e98347c02aaa39b223fe8d0a0e5c4f27ead9083c756cc202a00000000000000000000000000000000000000000000000000000001342cc75c6ee63c1e5014e68ccd3e89f51c3074ca5072bbac773960dfa36c02aaa39b223fe8d0a0e5c4f27ead9083c756cc202a000000000000000000000000000000000000000000000000000000013487f7673ee63c1e5016ca298d2983ab03aa1da7679389d955a4efee15cc02aaa39b223fe8d0a0e5c4f27ead9083c756cc25100d51a44d3fae010294c616388b506acda1bfaae46c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20044394747c5000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000303d5cd76a000000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000046aff9edb1ee63c1e50111b815efb8f581194ae79006d24e0d814b7697f6c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20020d6bdbf78dac17f958d2ee523a2206206994597c13d831ec75120bebc44782c7db0a1a60cb6fe97d0b483032ff1c7dac17f958d2ee523a2206206994597c13d831ec700443df021240000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000092217e71ef2bb1dea09c0020d6bdbf786b175474e89094c44da98b954eedeac495271d0f00a007e5c0d200000000000000000000000000000000051c0005160001d00001ca00003c41207f39c581f595b53c5cb19bd0b3f8da6c935e2ca00004de0e9a3e000000000000000000000000000000000000000000000000000000000000000000a0c9e75c48000000000000000021110000000000000000000000000000000000000000000000000001600000b0510021e27a5e5513d6e65c4f830167390997aa84843aae7ab96520de3a18e5e111b5eaab095312d7fe8400443df02124000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041ab4bf21c27f19d4c5120dc24316b9ae028f1497c275eb9192a3ea0f67022ae7ab96520de3a18e5e111b5eaab095312d7fe8400443df0212400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007f74f1334f6a7c775000206b4be0b900a0c9e75c480000000000001f05000e0000000000000000000000000000000000000003180002c900027a00026000a007e5c0d200000000000000000000000000000000023c0002220001720000b600009c4160c5424b857f758e906013f3555dad202e4bdb456700443df0212400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010020d6bdbf785e74c9036fb86bd7ecdcb084a0673efc32ea31cb4120c011a73ee8576fb46f5e1c5751ca3b9fe0af2a6f002444b3e92373455448000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000735553440000000000000000000000000000000000000000000000000000000031494e434800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005120a5407eae9ba41422680e2e00537571bcc53efbfd57ab1ec28d129707052df4df418d58a2d46d5f5100443df0212400000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010020d6bdbf78a0b86991c6218b36c1d19d4a2e9eb0ce3606eb484041c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2d0e30db002a00000000000000000000000000000000000000000000000000000009052f57730ee63c1e5008ad599c3a0ff1de082011efddc58f1908eb6e6d8c02aaa39b223fe8d0a0e5c4f27ead9083c756cc202a0000000000000000000000000000000000000000000000000000003809a4aea15ee63c1e50088e6a0c2ddd26feeb64f039a2c41296fcb3f5640c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200a0fd53121f00a0f2fa6b666b175474e89094c44da98b954eedeac495271d0f0000000000000000000000000000000000000000000b678a6566b854a407913800000000000000004568c0a104a49a1f80a06c4eca276b175474e89094c44da98b954eedeac495271d0f1111111254eeb25477b68fb85ed929f73a96058200a007e5c0d20000000000000001200000f20000d80000aa00009000006200004800001a0020d6bdbf78ae7ab96520de3a18e5e111b5eaab095312d7fe8480a06c4eca27ae7ab96520de3a18e5e111b5eaab095312d7fe845615deb798bb3e4dfa0139dfa1b3d433cc23b72f0020d6bdbf78ae7ab96520de3a18e5e111b5eaab095312d7fe8480a06c4eca27ae7ab96520de3a18e5e111b5eaab095312d7fe845615deb798bb3e4dfa0139dfa1b3d433cc23b72f0020d6bdbf78ae7ab96520de3a18e5e111b5eaab095312d7fe8480a06c4eca27ae7ab96520de3a18e5e111b5eaab095312d7fe845615deb798bb3e4dfa0139dfa1b3d433cc23b72f0020d6bdbf78ae7ab96520de3a18e5e111b5eaab095312d7fe8480a06c4eca27ae7ab96520de3a18e5e111b5eaab095312d7fe845615deb798bb3e4dfa0139dfa1b3d433cc23b72f00a007e5c0d20000000000000001200000f20000d80000aa00009000006200004800001a0020d6bdbf78ae7ab96520de3a18e5e111b5eaab095312d7fe8480a06c4eca27ae7ab96520de3a18e5e111b5eaab095312d7fe845615deb798bb3e4dfa0139dfa1b3d433cc23b72f0020d6bdbf78ae7ab96520de3a18e5e111b5eaab095312d7fe8480a06c4eca27ae7ab96520de3a18e5e111b5eaab095312d7fe845615deb798bb3e4dfa0139dfa1b3d433cc23b72f0020d6bdbf78ae7ab96520de3a18e5e111b5eaab095312d7fe8480a06c4eca27ae7ab96520de3a18e5e111b5eaab095312d7fe845615deb798bb3e4dfa0139dfa1b3d433cc23b72f0020d6bdbf78ae7ab96520de3a18e5e111b5eaab095312d7fe8480a06c4eca27ae7ab96520de3a18e5e111b5eaab095312d7fe845615deb798bb3e4dfa0139dfa1b3d433cc23b72f00a007e5c0d200000000000000000000000000000000000000000000000000004800001a0020d6bdbf78ae7ab96520de3a18e5e111b5eaab095312d7fe8480a06c4eca27ae7ab96520de3a18e5e111b5eaab095312d7fe845615deb798bb3e4dfa0139dfa1b3d433cc23b72f8c4b600c";

        IVault.BatchSwapStep[] memory swaps = new IVault.BatchSwapStep[](1);
        swaps[0] = IVault.BatchSwapStep({
            poolId: 0x20a61b948e33879ce7f23e535cc7baa3bc66c5a9000000000000000000000555,
            assetInIndex: 0,
            assetOutIndex: 1,
            amount: 0,
            userData: ""
        });

        IERC20[] memory assets = new IERC20[](2);
        assets[0] = IERC20(0x6B175474E89094C44Da98b954EedeAC495271d0F);
        /// DAI
        assets[1] = IERC20(0x183015a9bA6fF60230fdEaDc3F43b3D788b13e21);
        /// R
        uint256 deadline = type(uint256).max;

        bytes memory oneInchData = abi.encode(fromAmountOffset, swapCalldata);
        bytes memory balancerData = abi.encode(swaps, assets, deadline);
        bytes memory ammData =
            abi.encode(IERC20(0x6B175474E89094C44Da98b954EedeAC495271d0F), 1, true, oneInchData, balancerData);

        (,, IPriceFeed priceFeed,,,,,,,) = IPositionManager(positionManager).collateralInfo(collateralToken);

        vm.mockCall(address(priceFeed), abi.encodeWithSelector(IPriceFeed.fetchPrice.selector), abi.encode(1720e18, 0));

        liquidator.liquidate(whale, ammData);
        assertEq(positionManager.raftDebtToken(collateralToken).balanceOf(whale), 0);
    }
}
